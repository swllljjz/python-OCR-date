# 技术架构设计文档

## 1. 系统整体架构

### 1.1 分层架构设计
```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 文件上传GUI │  │ 批量处理GUI │  │ 结果展示与预警界面   │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Business Layer)                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 文件管理器   │  │ 批量处理器   │  │ 预警管理器          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 日期验证器   │  │ 结果聚合器   │  │ 配置管理器          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   核心引擎层 (Core Engine Layer)             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ OCR引擎     │  │ 图像处理器   │  │ 日期解析器          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 旋转检测器   │  │ 置信度评估   │  │ 格式标准化器        │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   数据访问层 (Data Access Layer)             │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 文件I/O     │  │ 图像加载器   │  │ 结果缓存            │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 配置存储     │  │ 日志记录     │  │ 报告生成器          │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 2. 核心模块设计

### 2.1 OCR引擎模块 (core/ocr_engine.py)
```python
class OCREngine:
    """OCR识别引擎核心类"""
    
    def __init__(self, config: OCRConfig):
        """初始化OCR引擎"""
        
    def recognize_text(self, image: np.ndarray) -> List[TextResult]:
        """识别图像中的所有文本"""
        
    def detect_orientation(self, image: np.ndarray) -> float:
        """检测文本方向角度"""
        
    def preprocess_image(self, image: np.ndarray) -> np.ndarray:
        """图像预处理"""
```

### 2.2 日期解析模块 (core/date_parser.py)
```python
class DateParser:
    """日期解析和验证类"""
    
    def parse_date_from_text(self, text_results: List[TextResult]) -> List[DateResult]:
        """从OCR结果中解析日期"""
        
    def validate_date(self, date_str: str) -> bool:
        """验证日期有效性"""
        
    def standardize_format(self, date_str: str) -> str:
        """标准化日期格式"""
```

### 2.3 图像处理模块 (core/image_processor.py)
```python
class ImageProcessor:
    """图像预处理类"""
    
    def enhance_image(self, image: np.ndarray) -> np.ndarray:
        """图像增强处理"""
        
    def correct_rotation(self, image: np.ndarray, angle: float) -> np.ndarray:
        """旋转校正"""
        
    def resize_image(self, image: np.ndarray, target_size: tuple) -> np.ndarray:
        """图像尺寸调整"""
```

## 3. 数据流设计

### 3.1 单张图片处理流程
```
输入图片 → 图像加载 → 预处理 → OCR识别 → 文本解析 → 日期验证 → 结果输出
    ↓         ↓        ↓       ↓        ↓        ↓        ↓
  File     PIL.Image  Enhanced  Text    Date    Valid    Result
  Path     Object     Image    Results  Candidates Date   Object
```

### 3.2 批量处理流程
```
文件夹扫描 → 文件过滤 → 并行处理 → 结果聚合 → 报告生成
    ↓          ↓        ↓        ↓        ↓
  File List  Image    Process   Results  Report
            Files     Pool     Collection
```

## 4. 接口设计

### 4.1 核心识别接口
```python
class DateRecognizer:
    """统一的日期识别接口"""
    
    def recognize_single(self, image_path: str) -> RecognitionResult:
        """识别单张图片"""
        
    def recognize_batch(self, image_paths: List[str]) -> List[RecognitionResult]:
        """批量识别"""
        
    def recognize_folder(self, folder_path: str) -> BatchResult:
        """识别文件夹"""
```

### 4.2 结果数据结构
```python
@dataclass
class RecognitionResult:
    """识别结果数据结构"""
    image_path: str
    success: bool
    dates_found: List[str]
    confidence: float
    processing_time: float
    warning_message: Optional[str]
    raw_text: List[str]
```

## 5. 配置管理

### 5.1 配置文件结构 (config/settings.yaml)
```yaml
ocr:
  engine: "paddleocr"
  language: "ch"
  use_gpu: false
  confidence_threshold: 0.8
  
image_processing:
  max_size: 1920
  enhance_contrast: true
  denoise: true
  
date_parsing:
  formats:
    - "YYYY.MM.DD"
    - "YYYY/MM/DD"
    - "YYYY-MM-DD"
    - "YYYYMMDD"
  year_range: [2020, 2030]
  
performance:
  max_workers: 4
  batch_size: 10
  cache_enabled: true
```

## 6. 错误处理策略

### 6.1 异常分类
```python
class OCRException(Exception):
    """OCR相关异常基类"""
    
class ImageProcessingError(OCRException):
    """图像处理异常"""
    
class DateParsingError(OCRException):
    """日期解析异常"""
    
class ConfigurationError(OCRException):
    """配置异常"""
```

### 6.2 错误恢复机制
- **图像处理失败**: 尝试不同的预处理参数
- **OCR识别失败**: 降低置信度阈值重试
- **日期解析失败**: 使用备用解析规则
- **批量处理中断**: 保存已处理结果，支持断点续传

## 7. 性能优化策略

### 7.1 内存优化
- 图像处理完成后立即释放内存
- 使用生成器处理大批量文件
- 实现LRU缓存机制

### 7.2 并行处理
- 多进程处理批量文件
- 异步I/O操作
- GPU加速(可选)

### 7.3 缓存策略
- 文件MD5缓存避免重复处理
- OCR模型预加载
- 结果缓存机制

## 8. 扩展性设计

### 8.1 V2版本接口预留
```python
class RealtimeRecognizer(DateRecognizer):
    """实时识别器(V2版本)"""
    
    def start_camera_stream(self, camera_id: int):
        """启动摄像头流"""
        
    def process_frame(self, frame: np.ndarray) -> RecognitionResult:
        """处理单帧图像"""
        
    def stop_stream(self):
        """停止流处理"""
```

### 8.2 插件化架构
- OCR引擎插件化
- 日期格式解析器插件化
- 预警规则插件化

## 9. 安全性考虑

### 9.1 输入验证
- 文件类型验证
- 文件大小限制
- 路径安全检查

### 9.2 资源保护
- 内存使用限制
- 处理时间超时
- 并发数量控制

## 10. 监控和日志

### 10.1 日志策略
- 分级日志记录(DEBUG/INFO/WARNING/ERROR)
- 性能指标记录
- 错误详情记录

### 10.2 监控指标
- 处理成功率
- 平均处理时间
- 内存使用情况
- 错误频率统计
