# 开发指南

## 1. 开发环境搭建

### 1.1 系统要求
- **操作系统**: Windows 10/11, macOS 10.15+, Ubuntu 18.04+
- **Python版本**: 3.8 - 3.11
- **内存**: 最少4GB，推荐8GB+
- **存储**: 至少2GB可用空间

### 1.2 环境安装步骤

#### Step 1: 创建虚拟环境
```bash
# 创建虚拟环境
python -m venv venv

# 激活虚拟环境
# Windows
venv\Scripts\activate
# macOS/Linux
source venv/bin/activate
```

#### Step 2: 安装依赖
```bash
# 升级pip
python -m pip install --upgrade pip

# 安装核心依赖
pip install paddlepaddle
pip install paddleocr
pip install opencv-python
pip install pillow
pip install numpy
pip install pyyaml
pip install tkinter

# 开发依赖
pip install pytest
pip install black
pip install flake8
pip install mypy
```

#### Step 3: 验证安装
```python
# test_installation.py
from paddleocr import PaddleOCR
import cv2
import numpy as np

def test_installation():
    try:
        ocr = PaddleOCR(use_angle_cls=True, lang='ch')
        print("✅ PaddleOCR安装成功")
        
        # 测试OpenCV
        img = np.zeros((100, 100, 3), dtype=np.uint8)
        print("✅ OpenCV安装成功")
        
        print("🎉 环境搭建完成!")
        return True
    except Exception as e:
        print(f"❌ 安装验证失败: {e}")
        return False

if __name__ == "__main__":
    test_installation()
```

## 2. 项目结构

### 2.1 目录结构
```
python-OCR-date/
├── README.md                 # 项目说明
├── requirements.txt          # 依赖列表
├── setup.py                 # 安装脚本
├── config/                  # 配置文件
│   ├── __init__.py
│   ├── settings.yaml        # 主配置文件
│   └── logging.yaml         # 日志配置
├── core/                    # 核心引擎
│   ├── __init__.py
│   ├── ocr_engine.py        # OCR引擎
│   ├── date_parser.py       # 日期解析器
│   ├── image_processor.py   # 图像处理器
│   └── models.py           # 数据模型
├── v1/                     # V1版本功能
│   ├── __init__.py
│   ├── gui/                # GUI界面
│   │   ├── __init__.py
│   │   ├── main_window.py  # 主窗口
│   │   ├── file_dialog.py  # 文件对话框
│   │   └── result_display.py # 结果显示
│   ├── handlers/           # 业务处理
│   │   ├── __init__.py
│   │   ├── file_handler.py # 文件处理
│   │   └── batch_processor.py # 批量处理
│   └── main.py            # V1主程序入口
├── v2/                    # V2版本(预留)
│   ├── __init__.py
│   └── realtime/          # 实时识别
├── utils/                 # 工具函数
│   ├── __init__.py
│   ├── logger.py          # 日志工具
│   ├── config_loader.py   # 配置加载
│   └── validators.py      # 验证工具
├── tests/                 # 测试用例
│   ├── __init__.py
│   ├── test_core/         # 核心模块测试
│   ├── test_v1/          # V1功能测试
│   └── test_data/        # 测试数据
├── docs/                  # 文档
│   ├── PRD.md
│   ├── 技术选型报告.md
│   ├── 技术架构设计.md
│   ├── 开发指南.md
│   └── API文档.md
└── test_image/           # 测试图片
    ├── 2025.06.24.jpg
    └── 2025.06.25.jpg
```

### 2.2 模块依赖关系
```
v1.main
    ↓
v1.gui.main_window
    ↓
v1.handlers.file_handler
    ↓
core.ocr_engine ← core.image_processor
    ↓
core.date_parser
    ↓
core.models
```

## 3. 编码规范

### 3.1 Python代码规范
- 遵循PEP 8编码规范
- 使用类型注解(Type Hints)
- 函数和类必须有文档字符串
- 变量和函数使用snake_case命名
- 类使用PascalCase命名
- 常量使用UPPER_CASE命名

### 3.2 代码示例
```python
from typing import List, Optional, Tuple
import logging

logger = logging.getLogger(__name__)

class DateRecognizer:
    """日期识别器类
    
    负责从图像中识别和解析日期信息
    
    Attributes:
        ocr_engine: OCR识别引擎
        date_parser: 日期解析器
    """
    
    def __init__(self, config: dict) -> None:
        """初始化日期识别器
        
        Args:
            config: 配置字典
        """
        self.ocr_engine = OCREngine(config)
        self.date_parser = DateParser(config)
        logger.info("DateRecognizer initialized")
    
    def recognize_date(self, image_path: str) -> Optional[str]:
        """识别图像中的日期
        
        Args:
            image_path: 图像文件路径
            
        Returns:
            识别到的日期字符串，如果未识别到则返回None
            
        Raises:
            FileNotFoundError: 图像文件不存在
            ValueError: 图像格式不支持
        """
        try:
            # 实现逻辑
            pass
        except Exception as e:
            logger.error(f"Date recognition failed: {e}")
            raise
```

### 3.3 注释规范
```python
# 单行注释：解释代码逻辑
def process_image(image_path: str) -> np.ndarray:
    """处理图像文件
    
    对输入图像进行预处理，包括尺寸调整、增强等操作
    
    Args:
        image_path (str): 图像文件路径
        
    Returns:
        np.ndarray: 处理后的图像数组
        
    Raises:
        FileNotFoundError: 文件不存在
        ValueError: 文件格式不支持
        
    Example:
        >>> processed_img = process_image("test.jpg")
        >>> print(processed_img.shape)
        (480, 640, 3)
    """
    # TODO: 实现图像处理逻辑
    pass
```

## 4. 测试策略

### 4.1 测试分类
- **单元测试**: 测试单个函数和类
- **集成测试**: 测试模块间交互
- **功能测试**: 测试完整功能流程
- **性能测试**: 测试处理速度和资源使用

### 4.2 测试用例编写
```python
# tests/test_core/test_date_parser.py
import pytest
from core.date_parser import DateParser

class TestDateParser:
    """日期解析器测试类"""
    
    def setup_method(self):
        """测试前置设置"""
        self.parser = DateParser()
    
    def test_parse_standard_format(self):
        """测试标准日期格式解析"""
        test_cases = [
            ("2025.06.24", "2025-06-24"),
            ("2025/06/24", "2025-06-24"),
            ("20250624", "2025-06-24"),
        ]
        
        for input_date, expected in test_cases:
            result = self.parser.parse_date(input_date)
            assert result == expected
    
    def test_invalid_date(self):
        """测试无效日期处理"""
        invalid_dates = ["2025.13.01", "2025.02.30", "abc"]
        
        for invalid_date in invalid_dates:
            with pytest.raises(ValueError):
                self.parser.parse_date(invalid_date)
    
    @pytest.mark.performance
    def test_parsing_performance(self):
        """测试解析性能"""
        import time
        
        start_time = time.time()
        for _ in range(1000):
            self.parser.parse_date("2025.06.24")
        end_time = time.time()
        
        assert (end_time - start_time) < 1.0  # 1000次解析应在1秒内完成
```

### 4.3 运行测试
```bash
# 运行所有测试
pytest

# 运行特定测试文件
pytest tests/test_core/test_date_parser.py

# 运行性能测试
pytest -m performance

# 生成覆盖率报告
pytest --cov=core --cov-report=html
```

## 5. 调试指南

### 5.1 日志配置
```python
# utils/logger.py
import logging
import logging.config
import yaml

def setup_logging(config_path: str = "config/logging.yaml"):
    """设置日志配置"""
    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)
    
    logging.config.dictConfig(config)
    return logging.getLogger(__name__)

# 使用示例
logger = setup_logging()
logger.info("应用启动")
logger.debug("调试信息")
logger.warning("警告信息")
logger.error("错误信息")
```

### 5.2 调试技巧
```python
# 1. 使用断点调试
import pdb
pdb.set_trace()  # 设置断点

# 2. 图像调试
import cv2
def debug_image(image: np.ndarray, window_name: str = "Debug"):
    """显示调试图像"""
    cv2.imshow(window_name, image)
    cv2.waitKey(0)
    cv2.destroyAllWindows()

# 3. 性能调试
import time
from functools import wraps

def timing_decorator(func):
    """性能计时装饰器"""
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        result = func(*args, **kwargs)
        end = time.time()
        print(f"{func.__name__} 执行时间: {end - start:.4f}秒")
        return result
    return wrapper

@timing_decorator
def slow_function():
    time.sleep(1)
```

## 6. 版本控制

### 6.1 Git工作流
```bash
# 1. 创建功能分支
git checkout -b feature/ocr-engine

# 2. 提交代码
git add .
git commit -m "feat: 实现OCR引擎基础功能"

# 3. 推送分支
git push origin feature/ocr-engine

# 4. 合并到主分支
git checkout main
git merge feature/ocr-engine
```

### 6.2 提交信息规范
```
feat: 新功能
fix: 修复bug
docs: 文档更新
style: 代码格式调整
refactor: 代码重构
test: 测试相关
chore: 构建过程或辅助工具的变动

示例:
feat: 添加日期解析功能
fix: 修复图像旋转角度计算错误
docs: 更新API文档
```

## 7. 部署指南

### 7.1 打包发布
```bash
# 1. 更新版本号
# setup.py中更新version

# 2. 构建包
python setup.py sdist bdist_wheel

# 3. 安装测试
pip install dist/python-ocr-date-1.0.0.tar.gz
```

### 7.2 配置文件
```yaml
# config/settings.yaml
app:
  name: "商品包装日期识别系统"
  version: "1.0.0"
  debug: false

ocr:
  engine: "paddleocr"
  model_dir: "./models"
  confidence_threshold: 0.8

logging:
  level: "INFO"
  file: "logs/app.log"
  max_size: "10MB"
  backup_count: 5
```

## 8. 常见问题

### 8.1 安装问题
**Q: PaddleOCR安装失败**
A: 检查Python版本，确保在3.8-3.11范围内，尝试使用清华源安装

**Q: 内存不足错误**
A: 调整batch_size参数，减少并行处理数量

### 8.2 运行问题
**Q: OCR识别精度低**
A: 检查图像质量，调整预处理参数，考虑使用GPU加速

**Q: 处理速度慢**
A: 启用GPU加速，调整图像尺寸，优化并行处理参数
